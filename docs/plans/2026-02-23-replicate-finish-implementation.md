# Finish Replicate Integration — Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Align the WordPress theme's Replicate integration with the MCP server's canonical presets, prompts, and configuration via a build script.

**Architecture:** A Node.js build script reads `wp-mcp-server/prompts/kaira-presets.js` and generates `kaira-theme/inc/kaira-presets-generated.php`. The theme's Image Studio and Replicate client are updated to consume this generated file instead of hardcoded prompts/presets.

**Tech Stack:** Node.js (build script), PHP (WordPress theme), ES modules

---

### Task 1: Create the Build Script

**Files:**
- Create: `scripts/sync-presets.js`

**Step 1: Create the sync script**

```js
#!/usr/bin/env node

/**
 * Sync Kaira presets from MCP server (source of truth) to WordPress theme.
 *
 * Usage: node scripts/sync-presets.js
 *
 * Reads:  wp-mcp-server/prompts/kaira-presets.js
 * Writes: kaira-theme/inc/kaira-presets-generated.php
 */

import { readFileSync, writeFileSync } from 'fs';
import { dirname, resolve } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = resolve(__dirname, '..');

// Dynamic import of the presets module
const {
  KAIRA_BASE_PROMPT,
  KAIRA_NEGATIVE_PROMPT,
  KAIRA_PRESETS,
  buildKairaPrompt,
} = await import(resolve(rootDir, 'wp-mcp-server/prompts/kaira-presets.js'));

// Escape a string for use inside PHP single-quoted strings
function phpEscape(str) {
  return str.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
}

// Build the PHP file
const presetEntries = Object.entries(KAIRA_PRESETS)
  .map(([key, val]) => {
    return `        '${phpEscape(key)}' => array(\n` +
           `            'description' => '${phpEscape(val.description)}',\n` +
           `            'scene'       => '${phpEscape(val.scene)}',\n` +
           `        )`;
  })
  .join(",\n");

const php = `<?php
/**
 * Kaira Presets — AUTO-GENERATED FILE.
 *
 * DO NOT EDIT. This file is generated by scripts/sync-presets.js
 * from wp-mcp-server/prompts/kaira-presets.js (the canonical source of truth).
 *
 * Regenerate with:  node scripts/sync-presets.js
 *
 * @package Kaira
 */

/**
 * Return the base identity prompt with trigger token replaced.
 *
 * @param string \$trigger Trigger token (default 'KAIRA').
 * @return string
 */
function kaira_get_base_prompt( string \$trigger = 'KAIRA' ): string {
    \$prompt = '${phpEscape(KAIRA_BASE_PROMPT)}';
    return str_replace( '{trigger}', \$trigger, \$prompt );
}

/**
 * Return the negative prompt applied to all generations.
 *
 * @return string
 */
function kaira_get_negative_prompt(): string {
    return '${phpEscape(KAIRA_NEGATIVE_PROMPT)}';
}

/**
 * Return all available scene presets.
 *
 * @return array<string, array{description: string, scene: string}>
 */
function kaira_get_presets(): array {
    return array(
${presetEntries},
    );
}

/**
 * Build a complete Kaira prompt from preset and/or custom description.
 *
 * @param string \$trigger           Trigger token (default 'KAIRA').
 * @param string \$preset_key        Preset name (optional).
 * @param string \$scene_description Custom scene description (optional).
 * @return string Assembled prompt.
 */
function kaira_build_prompt( string \$trigger = 'KAIRA', string \$preset_key = '', string \$scene_description = '' ): string {
    \$parts = array( kaira_get_base_prompt( \$trigger ) );

    if ( \$preset_key ) {
        \$presets = kaira_get_presets();
        if ( isset( \$presets[ \$preset_key ] ) ) {
            \$parts[] = \$presets[ \$preset_key ]['scene'];
        }
    }

    if ( \$scene_description ) {
        \$parts[] = \$scene_description;
    }

    return implode( '. ', \$parts );
}
`;

const outPath = resolve(rootDir, 'kaira-theme/inc/kaira-presets-generated.php');
writeFileSync(outPath, php, 'utf-8');

console.log(`Synced ${Object.keys(KAIRA_PRESETS).length} presets to ${outPath}`);
```

**Step 2: Run the script to generate the PHP file**

Run: `node scripts/sync-presets.js`
Expected: "Synced 12 presets to .../kaira-theme/inc/kaira-presets-generated.php"

**Step 3: Verify the generated PHP file**

Run: `php -l kaira-theme/inc/kaira-presets-generated.php`
Expected: "No syntax errors detected"

**Step 4: Commit**

```bash
git add scripts/sync-presets.js kaira-theme/inc/kaira-presets-generated.php
git commit -m "feat: add preset sync script and generated PHP presets"
```

---

### Task 2: Update Theme to Use Generated Presets

**Files:**
- Modify: `kaira-theme/functions.php` (add require for generated presets)
- Modify: `kaira-theme/inc/image-studio.php` (use generated presets + functions)

**Step 1: Add require for generated presets in functions.php**

In `kaira-theme/functions.php`, add after the `require ...replicate-api.php` line:

```php
require get_template_directory() . '/inc/kaira-presets-generated.php';
```

**Step 2: Replace hardcoded preset dropdown in image-studio.php**

Replace the hardcoded `<select id="kaira-preset">` block (lines 107-117) with a dynamic loop:

```php
<select id="kaira-preset" class="regular-text">
    <option value="">-- Custom (use description below) --</option>
    <?php foreach ( kaira_get_presets() as $key => $preset ) : ?>
        <option value="<?php echo esc_attr( $key ); ?>">
            <?php echo esc_html( ucwords( str_replace( '_', ' ', $key ) ) ); ?>
            — <?php echo esc_html( $preset['description'] ); ?>
        </option>
    <?php endforeach; ?>
</select>
```

**Step 3: Replace `get_identity_prompt()` method**

Replace the body of `get_identity_prompt()` (line 284-285) with:

```php
private function get_identity_prompt(): string {
    return kaira_get_base_prompt(
        defined( 'KAIRA_TRIGGER_TOKEN' ) ? KAIRA_TRIGGER_TOKEN : 'KAIRA'
    );
}
```

**Step 4: Replace `get_negative_prompt()` method**

Replace the body of `get_negative_prompt()` (line 293-294) with:

```php
private function get_negative_prompt(): string {
    return kaira_get_negative_prompt();
}
```

**Step 5: Replace `get_preset_prompt()` method**

Replace the body of `get_preset_prompt()` (lines 303-316) with:

```php
private function get_preset_prompt( string $preset ): string {
    $presets = kaira_get_presets();
    return $presets[ $preset ]['scene'] ?? '';
}
```

**Step 6: Commit**

```bash
git add kaira-theme/functions.php kaira-theme/inc/image-studio.php
git commit -m "feat: use generated presets in Image Studio — all 12 presets, aligned prompts"
```

---

### Task 3: Update Theme Polling Timeout

**Files:**
- Modify: `kaira-theme/inc/replicate-api.php`

**Step 1: Update default max_attempts from 60 to 120**

In `replicate-api.php` line 103, change:

```php
public function poll_prediction( string $prediction_id, int $max_attempts = 60, int $interval = 2 ) {
```

to:

```php
public function poll_prediction( string $prediction_id, int $max_attempts = 120, int $interval = 2 ) {
```

**Step 2: Verify syntax**

Run: `php -l kaira-theme/inc/replicate-api.php`
Expected: "No syntax errors detected"

**Step 3: Commit**

```bash
git add kaira-theme/inc/replicate-api.php
git commit -m "fix: increase Replicate polling timeout to 4 minutes to match MCP server"
```

---

### Task 4: Update Theme Zip Package

**Files:**
- The kaira-theme.zip needs to be regenerated with the new/changed files

**Step 1: Rebuild theme zip**

```bash
cd /Users/curtisvaughan/Kaira
zip -r kaira-theme.zip kaira-theme/ \
  -x "kaira-theme/.DS_Store" \
  -x "kaira-theme/**/.DS_Store"
```

**Step 2: Commit**

```bash
git add kaira-theme.zip
git commit -m "chore: rebuild theme zip with aligned Replicate presets"
```
